<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>正念饮食练习 - MindFit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4A6157",
            secondary: "#F7F6F2", 
            accent: "#2E2E2E",
            mint: "#8FD9A8",
            light: "#FAFAFA",
            white: "#FFFFFF",
            content: "#444444",
            gray: "#666666",
            lightGray: "#777777",
          },
        },
      },
    };
  </script>
  
  <style>
    /* 页面加载动画 */
    .page-content {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 步骤卡片动画 */
    .step-card {
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0.5;
      transform: scale(0.95);
    }

    .step-card.active {
      opacity: 1;
      transform: scale(1);
      box-shadow: 0 8px 25px rgba(74, 97, 87, 0.2);
    }

    .step-card.completed {
      opacity: 0.7;
      transform: scale(0.98);
    }

    /* 按钮样式 */
    .btn-primary {
      background: linear-gradient(135deg, #4A6157, #8FD9A8);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 4px 20px rgba(74, 97, 87, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 30px rgba(74, 97, 87, 0.3);
    }

    .btn-secondary {
      border: 2px solid #4A6157;
      color: #4A6157;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    .btn-secondary:hover {
      background: #8FD9A8;
      border-color: #8FD9A8;
      color: white;
      transform: translateY(-2px);
    }

    /* 进度条 */
    .progress-bar {
      transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      background: linear-gradient(90deg, #4A6157, #8FD9A8);
    }

    /* 计时器圆圈 */
    .timer-circle {
      stroke-dasharray: 251;
      stroke-dashoffset: 251;
      transition: stroke-dashoffset 1s ease;
    }

    /* 食物图标动画 */
    .food-icon {
      transition: all 0.3s ease;
    }

    .food-icon:hover {
      transform: scale(1.1);
    }

    /* 反思区域 */
    .reflection-area {
      background: linear-gradient(135deg, rgba(143, 217, 168, 0.1), rgba(74, 97, 87, 0.05));
      border: 1px solid rgba(143, 217, 168, 0.3);
    }

    /* Toast 样式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4A6157, #8FD9A8);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 8px 32px rgba(74, 97, 87, 0.3);
    }

    .toast.show {
      transform: translateX(0);
    }

    /* 音频控制样式 */
    .audio-controls {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(74, 97, 87, 0.2);
    }

    /* 彩带庆祝动画 */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #f0f;
      animation: confetti-fall 3s linear infinite;
      z-index: 9999;
    }

    .confetti:nth-child(1) { 
      background: #ff6b6b; 
      left: 10%; 
      animation-delay: 0s;
      animation-duration: 3s;
    }
    .confetti:nth-child(2) { 
      background: #4ecdc4; 
      left: 20%; 
      animation-delay: 0.5s;
      animation-duration: 2.5s;
    }
    .confetti:nth-child(3) { 
      background: #45b7d1; 
      left: 30%; 
      animation-delay: 1s;
      animation-duration: 3.5s;
    }
    .confetti:nth-child(4) { 
      background: #f9ca24; 
      left: 40%; 
      animation-delay: 0.3s;
      animation-duration: 2.8s;
    }
    .confetti:nth-child(5) { 
      background: #f0932b; 
      left: 50%; 
      animation-delay: 0.7s;
      animation-duration: 3.2s;
    }
    .confetti:nth-child(6) { 
      background: #eb4d4b; 
      left: 60%; 
      animation-delay: 1.2s;
      animation-duration: 2.7s;
    }
    .confetti:nth-child(7) { 
      background: #6c5ce7; 
      left: 70%; 
      animation-delay: 0.2s;
      animation-duration: 3.1s;
    }
    .confetti:nth-child(8) { 
      background: #a29bfe; 
      left: 80%; 
      animation-delay: 0.9s;
      animation-duration: 2.9s;
    }
    .confetti:nth-child(9) { 
      background: #fd79a8; 
      left: 90%; 
      animation-delay: 1.5s;
      animation-duration: 3.3s;
    }
    .confetti:nth-child(10) { 
      background: #00b894; 
      left: 15%; 
      animation-delay: 0.4s;
      animation-duration: 2.6s;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      10% {
        transform: translateY(-90vh) rotate(36deg);
        opacity: 1;
      }
      20% {
        transform: translateY(-80vh) rotate(72deg);
        opacity: 1;
      }
      30% {
        transform: translateY(-70vh) rotate(108deg);
        opacity: 1;
      }
      40% {
        transform: translateY(-60vh) rotate(144deg);
        opacity: 1;
      }
      50% {
        transform: translateY(-50vh) rotate(180deg);
        opacity: 1;
      }
      60% {
        transform: translateY(-40vh) rotate(216deg);
        opacity: 1;
      }
      70% {
        transform: translateY(-30vh) rotate(252deg);
        opacity: 1;
      }
      80% {
        transform: translateY(-20vh) rotate(288deg);
        opacity: 0.8;
      }
      90% {
        transform: translateY(-10vh) rotate(324deg);
        opacity: 0.5;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* 彩带的不同形状 */
    .confetti.square {
      border-radius: 0;
    }
    .confetti.circle {
      border-radius: 50%;
    }
    .confetti.triangle {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 10px solid;
    }
  </style>
</head>

<body class="bg-secondary font-sans min-h-screen">
  <!-- 顶部导航 -->
  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 backdrop-blur-md bg-white/90">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <a href="daily_practice.html" class="flex items-center text-primary hover:text-mint transition-all duration-300 group">
            <span class="mr-2 transition-transform group-hover:-translate-x-1">←</span>
            <span class="font-medium">返回练习</span>
          </a>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center">
            <i class="fa fa-apple text-white text-sm"></i>
          </div>
          <span class="text-lg font-bold text-primary">正念饮食</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Toast 提示 -->
  <div id="toast" class="toast">
    <div class="flex items-center">
      <span class="mr-2">✓</span>
      <span id="toastMessage"></span>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="page-content">
      
      <!-- 页面标题 -->
      <div class="text-center mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-primary mb-2">正念饮食练习</h1>
        <p class="text-content">慢一点，和味道好好相处</p>
      </div>

      <!-- 练习进度 -->
      <div class="bg-white rounded-2xl p-6 shadow-sm mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-primary">练习进度</h2>
          <span class="text-sm text-gray-500" id="progressText">0/5 步骤</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progressBar" class="progress-bar h-3 rounded-full" style="width: 0%"></div>
        </div>
      </div>

      <!-- 选择食物 -->
      <div id="foodSelection" class="bg-white rounded-2xl p-6 shadow-sm mb-6">
        <h3 class="text-xl font-semibold text-primary mb-4">第一步：选择你的食物</h3>
        <p class="text-gray-600 mb-6">选择一种小份量的食物开始正念饮食练习：</p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="food-option text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all" data-food="葡萄干">
            <div class="food-icon text-4xl mb-2">🍇</div>
            <div class="text-sm font-medium">葡萄干</div>
          </div>
          <div class="food-option text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all" data-food="坚果">
            <div class="food-icon text-4xl mb-2">🥜</div>
            <div class="text-sm font-medium">坚果</div>
          </div>
          <div class="food-option text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all" data-food="巧克力">
            <div class="food-icon text-4xl mb-2">🍫</div>
            <div class="text-sm font-medium">巧克力</div>
          </div>
          <div class="food-option text-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-all" data-food="其他">
            <div class="food-icon text-4xl mb-2">🍽️</div>
            <div class="text-sm font-medium">其他</div>
          </div>
        </div>

        <div class="text-center">
          <button id="startPracticeBtn" class="btn-primary text-white px-8 py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            开始练习
          </button>
        </div>
      </div>

      <!-- 练习步骤 -->
      <div id="practiceSteps" class="space-y-6 hidden">
        
        <!-- 步骤1：观察 -->
        <div class="step-card bg-white rounded-2xl p-6 shadow-sm" data-step="1">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-4 font-bold">1</div>
            <h3 class="text-xl font-semibold text-primary">仔细观察</h3>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-600 mb-4">花2分钟时间仔细观察你选择的食物：</p>
              <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>• 注意它的颜色、形状和大小</li>
                <li>• 观察表面的质地和纹理</li>
                <li>• 看看它在光线下的样子</li>
                <li>• 注意任何独特的特征</li>
              </ul>
            </div>
            
            <div class="text-center">
              <div class="relative w-24 h-24 mx-auto mb-4">
                <svg class="w-24 h-24 transform -rotate-90">
                  <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="6" fill="none"/>
                  <circle id="timer1" cx="48" cy="48" r="40" stroke="#4A6157" stroke-width="6" fill="none" 
                          class="timer-circle"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span id="timerDisplay1" class="text-lg font-bold text-primary">2:00</span>
                </div>
              </div>
              <button id="startStep1" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                <i class="fa fa-play mr-2"></i>开始观察
              </button>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2">记录你观察到的：</label>
            <textarea id="observation" rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none" 
                      placeholder="例如：葡萄干呈深紫色，表面有细小的皱纹..."></textarea>
          </div>
        </div>

        <!-- 步骤2：嗅觉 -->
        <div class="step-card bg-white rounded-2xl p-6 shadow-sm" data-step="2">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mr-4 font-bold">2</div>
            <h3 class="text-xl font-semibold text-primary">感受香味</h3>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-600 mb-4">将食物靠近鼻子，花1分钟感受它的香味：</p>
              <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>• 深深吸气，感受食物的气味</li>
                <li>• 注意香味的强度和层次</li>
                <li>• 观察嗅觉如何影响你的感受</li>
                <li>• 是否唤起了某些记忆或情感？</li>
              </ul>
            </div>
            
            <div class="text-center">
              <div class="relative w-24 h-24 mx-auto mb-4">
                <svg class="w-24 h-24 transform -rotate-90">
                  <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="6" fill="none"/>
                  <circle id="timer2" cx="48" cy="48" r="40" stroke="#8FD9A8" stroke-width="6" fill="none" 
                          class="timer-circle"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span id="timerDisplay2" class="text-lg font-bold text-primary">1:00</span>
                </div>
              </div>
              <button id="startStep2" class="btn-secondary px-4 py-2 rounded-lg text-sm" disabled>
                <i class="fa fa-play mr-2"></i>开始感受
              </button>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2">记录你感受到的香味：</label>
            <textarea id="smell" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none" 
                      placeholder="例如：淡淡的甜味，带有一丝果香..."></textarea>
          </div>
        </div>

        <!-- 步骤3：触觉 -->
        <div class="step-card bg-white rounded-2xl p-6 shadow-sm" data-step="3">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mr-4 font-bold">3</div>
            <h3 class="text-xl font-semibold text-primary">感受质地</h3>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-600 mb-4">用手指轻轻触摸食物，感受它的质地：</p>
              <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>• 注意食物的软硬程度</li>
                <li>• 感受表面的纹理和温度</li>
                <li>• 观察重量和密度</li>
                <li>• 注意触摸时的感觉</li>
              </ul>
            </div>
            
            <div class="text-center">
              <div class="text-6xl mb-4">✋</div>
              <button id="completeStep3" class="btn-secondary px-4 py-2 rounded-lg text-sm" disabled>
                完成触摸
              </button>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2">记录你感受到的质地：</label>
            <textarea id="texture" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none" 
                      placeholder="例如：表面有些粗糙，质地较硬..."></textarea>
          </div>
        </div>

        <!-- 步骤4：品尝 -->
        <div class="step-card bg-white rounded-2xl p-6 shadow-sm" data-step="4">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mr-4 font-bold">4</div>
            <h3 class="text-xl font-semibold text-primary">慢慢品尝</h3>
          </div>
          
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-600 mb-4">将食物放入口中，慢慢咀嚼3分钟：</p>
              <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>• 第一口：注意初始的味道</li>
                <li>• 慢慢咀嚼，感受味道的变化</li>
                <li>• 注意口感和质地的变化</li>
                <li>• 观察吞咽时的感觉</li>
              </ul>
            </div>
            
            <div class="text-center">
              <div class="relative w-24 h-24 mx-auto mb-4">
                <svg class="w-24 h-24 transform -rotate-90">
                  <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="6" fill="none"/>
                  <circle id="timer4" cx="48" cy="48" r="40" stroke="#A855F7" stroke-width="6" fill="none" 
                          class="timer-circle"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span id="timerDisplay4" class="text-lg font-bold text-primary">3:00</span>
                </div>
              </div>
              <button id="startStep4" class="btn-secondary px-4 py-2 rounded-lg text-sm" disabled>
                <i class="fa fa-play mr-2"></i>开始品尝
              </button>
            </div>
          </div>
          
          <div class="mt-6 p-4 bg-gray-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2">记录味觉体验：</label>
            <textarea id="taste" rows="3" class="w-full p-3 border border-gray-300 rounded-lg resize-none" 
                      placeholder="例如：开始有淡淡的甜味，咀嚼后变得更加浓郁..."></textarea>
          </div>
        </div>

        <!-- 步骤5：反思 -->
        <div class="step-card bg-white rounded-2xl p-6 shadow-sm" data-step="5">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center mr-4 font-bold">5</div>
            <h3 class="text-xl font-semibold text-primary">练习反思</h3>
          </div>
          
          <div class="reflection-area rounded-lg p-6">
            <p class="text-gray-600 mb-6">花几分钟时间反思这次正念饮食的体验：</p>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">1. 与平常的饮食体验相比，你注意到了什么不同？</label>
                <textarea id="reflection1" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none"></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">2. 这种慢慢品尝的方式让你有什么感受？</label>
                <textarea id="reflection2" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none"></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">3. 你愿意在日常饮食中尝试这种方式吗？</label>
                <textarea id="reflection3" rows="2" class="w-full p-3 border border-gray-300 rounded-lg resize-none"></textarea>
              </div>
            </div>
          </div>
          
          <div class="text-center mt-6">
            <button id="completePractice" class="btn-primary text-white px-8 py-3 rounded-lg font-medium">
              完成练习
            </button>
          </div>
        </div>

      </div>

      <!-- 练习完成 -->
      <div id="practiceComplete" class="bg-white rounded-2xl p-8 shadow-sm text-center hidden">
        <div class="text-6xl mb-4">🎉</div>
        <h2 class="text-2xl font-bold text-primary mb-4">恭喜完成正念饮食练习！</h2>
        <p class="text-gray-600 mb-6">你已经体验了用全新的方式与食物相处。这种觉察和专注可以帮助你建立更健康的饮食关系。</p>
        
        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-green-50 rounded-lg">
            <div class="text-2xl mb-2">🧘</div>
            <div class="text-sm font-medium text-green-700">增强觉察力</div>
          </div>
          <div class="p-4 bg-blue-50 rounded-lg">
            <div class="text-2xl mb-2">💚</div>
            <div class="text-sm font-medium text-blue-700">改善食物关系</div>
          </div>
          <div class="p-4 bg-purple-50 rounded-lg">
            <div class="text-2xl mb-2">⚖️</div>
            <div class="text-sm font-medium text-purple-700">平衡饮食习惯</div>
          </div>
        </div>
        
        <div class="flex flex-col md:flex-row gap-4 justify-center">
          <button onclick="savePracticeRecord()" class="btn-primary text-white px-6 py-3 rounded-lg">
            <i class="fa fa-save mr-2"></i>保存记录
          </button>
          <button onclick="restartPractice()" class="btn-secondary px-6 py-3 rounded-lg">
            <i class="fa fa-refresh mr-2"></i>再次练习
          </button>
          <button onclick="window.location.href='daily_practice.html'" class="btn-secondary px-6 py-3 rounded-lg">
            <i class="fa fa-arrow-left mr-2"></i>返回练习
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- 背景音乐控制 -->
  <div class="audio-controls fixed bottom-4 right-4 rounded-lg p-3 shadow-lg">
    <div class="flex items-center space-x-3">
      <button id="audioToggle" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">
        <i class="fa fa-music"></i>
      </button>
      <div class="hidden md:block">
        <div class="text-xs text-gray-600">背景音乐</div>
        <input type="range" id="volumeControl" min="0" max="100" value="50" class="w-16">
      </div>
    </div>
  </div>

  <!-- 隐藏的音频元素 -->
  <audio id="backgroundAudio" loop>
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQpF1O66+KdSgwJU6Xd7M2mXgcOXbDn7qJQFQw=" type="audio/wav">
  </audio>

  <script>
    // 全局变量
    let currentStep = 0;
    let selectedFood = '';
    let stepTimers = {};
    let practiceStartTime = null;
    let backgroundAudioEnabled = false;

    // 正念饮食练习数据结构
    let practiceData = {
      food: '',
      startTime: null,
      endTime: null,
      observations: {
        visual: '',
        smell: '',
        texture: '',
        taste: '',
        reflections: []
      }
    };

    // Toast 提示功能
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // 格式化时间显示
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // 彩带庆祝动画
    function showConfettiCelebration() {
      // 创建彩带容器
      const confettiContainer = document.createElement('div');
      confettiContainer.style.position = 'fixed';
      confettiContainer.style.top = '0';
      confettiContainer.style.left = '0';
      confettiContainer.style.width = '100%';
      confettiContainer.style.height = '100%';
      confettiContainer.style.pointerEvents = 'none';
      confettiContainer.style.zIndex = '9999';
      
      // 创建多个彩带
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#a29bfe', '#fd79a8', '#00b894'];
      const shapes = ['square', 'circle', 'triangle'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = `confetti ${shapes[Math.floor(Math.random() * shapes.length)]}`;
        
        // 随机位置和颜色
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        
        // 随机大小
        const size = Math.random() * 8 + 4;
        confetti.style.width = size + 'px';
        confetti.style.height = size + 'px';
        
        // 三角形特殊处理
        if (confetti.classList.contains('triangle')) {
          confetti.style.borderBottomColor = confetti.style.backgroundColor;
          confetti.style.backgroundColor = 'transparent';
        }
        
        confettiContainer.appendChild(confetti);
      }
      
      document.body.appendChild(confettiContainer);
      
      // 4秒后清除彩带
      setTimeout(() => {
        if (document.body.contains(confettiContainer)) {
          document.body.removeChild(confettiContainer);
        }
      }, 4000);
      
      // 播放庆祝音效（如果支持）
      playSuccessSound();
    }

    // 播放成功音效
    function playSuccessSound() {
      try {
        // 创建简单的成功音效
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // 创建音符序列（C大调和弦）
        const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
        
        notes.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = freq;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.1);
          gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + index * 0.1 + 0.05);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.1 + 0.3);
          
          oscillator.start(audioContext.currentTime + index * 0.1);
          oscillator.stop(audioContext.currentTime + index * 0.1 + 0.3);
        });
      } catch (error) {
        console.log('Audio not supported');
      }
    }

    // 更新进度条
    function updateProgress() {
      const progress = (currentStep / 5) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
      document.getElementById('progressText').textContent = `${currentStep}/5 步骤`;
    }

    // 更新步骤状态
    function updateStepStates() {
      document.querySelectorAll('.step-card').forEach((card, index) => {
        const stepNum = index + 1;
        card.classList.remove('active', 'completed');
        
        if (stepNum < currentStep) {
          card.classList.add('completed');
        } else if (stepNum === currentStep) {
          card.classList.add('active');
        }
      });
    }

    // 食物选择处理
    function initFoodSelection() {
      document.querySelectorAll('.food-option').forEach(option => {
        option.addEventListener('click', () => {
          // 清除之前的选择
          document.querySelectorAll('.food-option').forEach(opt => {
            opt.classList.remove('border-primary', 'bg-primary/5');
            opt.classList.add('border-gray-200');
          });
          
          // 标记当前选择
          option.classList.remove('border-gray-200');
          option.classList.add('border-primary', 'bg-primary/5');
          
          selectedFood = option.dataset.food;
          practiceData.food = selectedFood;
          
          // 启用开始按钮
          document.getElementById('startPracticeBtn').disabled = false;
        });
      });
      
      document.getElementById('startPracticeBtn').addEventListener('click', startPractice);
    }

    // 开始练习
    function startPractice() {
      if (!selectedFood) {
        showToast('请先选择一种食物');
        return;
      }
      
      practiceData.startTime = new Date().toISOString();
      practiceStartTime = Date.now();
      
      // 隐藏食物选择，显示练习步骤
      document.getElementById('foodSelection').classList.add('hidden');
      document.getElementById('practiceSteps').classList.remove('hidden');
      
      currentStep = 1;
      updateProgress();
      updateStepStates();
      
      showToast(`开始正念饮食练习：${selectedFood}`);
      initStepHandlers();
    }

    // 初始化步骤处理器
    function initStepHandlers() {
      // 步骤1：观察
      document.getElementById('startStep1').addEventListener('click', () => {
        startStepTimer('timer1', 'timerDisplay1', 120, () => {
          // 保存观察记录
          practiceData.observations.visual = document.getElementById('observation').value;
          completeStep(1);
        });
      });

      // 步骤2：嗅觉
      document.getElementById('startStep2').addEventListener('click', () => {
        startStepTimer('timer2', 'timerDisplay2', 60, () => {
          practiceData.observations.smell = document.getElementById('smell').value;
          completeStep(2);
        });
      });

      // 步骤3：触觉
      document.getElementById('completeStep3').addEventListener('click', () => {
        practiceData.observations.texture = document.getElementById('texture').value;
        completeStep(3);
      });

      // 步骤4：品尝
      document.getElementById('startStep4').addEventListener('click', () => {
        startStepTimer('timer4', 'timerDisplay4', 180, () => {
          practiceData.observations.taste = document.getElementById('taste').value;
          completeStep(4);
        });
      });

      // 步骤5：反思
      document.getElementById('completePractice').addEventListener('click', () => {
        // 保存反思
        practiceData.observations.reflections = [
          document.getElementById('reflection1').value,
          document.getElementById('reflection2').value,
          document.getElementById('reflection3').value
        ];
        completeStep(5);
        showPracticeComplete();
      });
    }

    // 开始步骤计时器
    function startStepTimer(circleId, displayId, duration, onComplete) {
      const circle = document.getElementById(circleId);
      const display = document.getElementById(displayId);
      
      let timeLeft = duration;
      const circumference = 2 * Math.PI * 40;
      
      // 重置圆圈
      circle.style.strokeDashoffset = circumference;
      
      const timer = setInterval(() => {
        timeLeft--;
        display.textContent = formatTime(timeLeft);
        
        // 更新圆圈进度
        const progress = (duration - timeLeft) / duration;
        const offset = circumference - (progress * circumference);
        circle.style.strokeDashoffset = offset;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          onComplete();
        }
      }, 1000);
      
      stepTimers[circleId] = timer;
    }

    // 完成步骤
    function completeStep(stepNumber) {
      currentStep = stepNumber + 1;
      updateProgress();
      updateStepStates();
      
      // 启用下一步
      if (stepNumber < 5) {
        enableNextStep(stepNumber + 1);
      }
      
      showToast(`第${stepNumber}步完成！`);
    }

    // 启用下一步
    function enableNextStep(nextStep) {
      const stepButtons = {
        2: 'startStep2',
        3: 'completeStep3',
        4: 'startStep4',
        5: 'completePractice'
      };
      
      const buttonId = stepButtons[nextStep];
      if (buttonId) {
        document.getElementById(buttonId).disabled = false;
      }
    }

    // 显示练习完成
    function showPracticeComplete() {
      practiceData.endTime = new Date().toISOString();
      
      // 隐藏步骤，显示完成页面
      document.getElementById('practiceSteps').classList.add('hidden');
      document.getElementById('practiceComplete').classList.remove('hidden');
      
      // 🎉 显示彩带庆祝动画
      showConfettiCelebration();
      
      // 计算练习时长
      const duration = Math.round((Date.now() - practiceStartTime) / 1000 / 60);
      showToast(`练习完成！总耗时 ${duration} 分钟`);
    }

    // 保存练习记录
    function savePracticeRecord() {
      const records = JSON.parse(localStorage.getItem('mindfulEatingRecords') || '[]');
      
      const record = {
        id: Date.now(),
        ...practiceData,
        duration: Math.round((Date.now() - practiceStartTime) / 1000 / 60)
      };
      
      records.push(record);
      localStorage.setItem('mindfulEatingRecords', JSON.stringify(records));
      
      showToast('练习记录已保存！');
    }

    // 重新开始练习
    function restartPractice() {
      // 重置所有状态
      currentStep = 0;
      selectedFood = '';
      practiceData = {
        food: '',
        startTime: null,
        endTime: null,
        observations: {
          visual: '',
          smell: '',
          texture: '',
          taste: '',
          reflections: []
        }
      };
      
      // 清空所有输入
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.value = '';
      });
      
      // 重置UI
      document.getElementById('practiceComplete').classList.add('hidden');
      document.getElementById('foodSelection').classList.remove('hidden');
      document.getElementById('practiceSteps').classList.add('hidden');
      
      // 重置食物选择
      document.querySelectorAll('.food-option').forEach(opt => {
        opt.classList.remove('border-primary', 'bg-primary/5');
        opt.classList.add('border-gray-200');
      });
      
      document.getElementById('startPracticeBtn').disabled = true;
      
      // 重置按钮状态
      ['startStep2', 'completeStep3', 'startStep4'].forEach(id => {
        document.getElementById(id).disabled = true;
      });
      
      updateProgress();
      showToast('练习已重置，可以重新开始');
    }

    // 背景音乐控制
    function initAudioControls() {
      const audioToggle = document.getElementById('audioToggle');
      const volumeControl = document.getElementById('volumeControl');
      const backgroundAudio = document.getElementById('backgroundAudio');
      
      audioToggle.addEventListener('click', () => {
        if (backgroundAudioEnabled) {
          backgroundAudio.pause();
          audioToggle.innerHTML = '<i class="fa fa-music"></i>';
          backgroundAudioEnabled = false;
        } else {
          backgroundAudio.play().catch(() => {
            showToast('无法播放背景音乐');
          });
          audioToggle.innerHTML = '<i class="fa fa-pause"></i>';
          backgroundAudioEnabled = true;
        }
      });
      
      volumeControl.addEventListener('input', (e) => {
        backgroundAudio.volume = e.target.value / 100;
      });
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
      initFoodSelection();
      initAudioControls();
      updateProgress();
      
      // 欢迎提示
      setTimeout(() => {
        showToast('欢迎来到正念饮食练习！请选择一种食物开始');
      }, 1000);
    });

    // 键盘快捷键
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (confirm('确定要退出练习吗？')) {
          window.location.href = 'daily_practice.html';
        }
      }
    });

    // 防止意外离开
    window.addEventListener('beforeunload', (e) => {
      if (currentStep > 0 && currentStep < 5) {
        e.preventDefault();
        e.returnValue = '练习进行中，确定要离开吗？';
      }
    });

    // 自动保存草稿
    function autoSave() {
      if (currentStep > 0) {
        const draft = {
          currentStep,
          selectedFood,
          practiceData,
          timestamp: Date.now()
        };
        localStorage.setItem('mindfulEatingDraft', JSON.stringify(draft));
      }
    }

    // 每30秒自动保存一次
    setInterval(autoSave, 30000);

    // 页面加载时恢复草稿
    function loadDraft() {
      const draft = localStorage.getItem('mindfulEatingDraft');
      if (draft) {
        const draftData = JSON.parse(draft);
        const timeDiff = Date.now() - draftData.timestamp;
        
        // 如果草稿是24小时内的，询问是否恢复
        if (timeDiff < 24 * 60 * 60 * 1000) {
          if (confirm('发现未完成的练习，是否继续？')) {
            currentStep = draftData.currentStep;
            selectedFood = draftData.selectedFood;
            practiceData = draftData.practiceData;
            
            // 恢复UI状态
            if (currentStep > 0) {
              document.getElementById('foodSelection').classList.add('hidden');
              document.getElementById('practiceSteps').classList.remove('hidden');
              updateProgress();
              updateStepStates();
            }
          } else {
            localStorage.removeItem('mindfulEatingDraft');
          }
        }
      }
    }

    // 页面加载完成后检查草稿
    window.addEventListener('load', loadDraft);
  </script>
<!-- MindFit 数据管理器 -->
<script src="js/data-manager.js"></script>

</body>
</html>
</body>
</html>
