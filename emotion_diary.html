<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æƒ…ç»ªæ—¥è®° - MindFit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4A6157",
            secondary: "#F7F6F2", 
            accent: "#2E2E2E",
            mint: "#8FD9A8",
          },
        },
      },
    };
  </script>
  
  <style>
    .emotion-card {
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      border: 3px solid transparent;
    }
    
    .emotion-card:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    .emotion-card.selected {
      border-color: #4A6157;
      background: linear-gradient(135deg, rgba(74, 97, 87, 0.05), rgba(143, 217, 168, 0.05));
      transform: scale(1.05);
    }

    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #4A6157;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4A6157, #8FD9A8);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.4s ease;
      box-shadow: 0 8px 32px rgba(74, 97, 87, 0.3);
    }

    .toast.show {
      transform: translateX(0);
    }
  </style>
</head>

<body class="bg-secondary font-sans min-h-screen">
  
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 backdrop-blur-md bg-white/90">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <a href="cbt_tools.html" class="flex items-center text-primary hover:text-mint transition-all duration-300 group">
            <span class="mr-2 transition-transform group-hover:-translate-x-1">â†</span>
            <span class="font-medium">è¿”å›å·¥å…·</span>
          </a>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center">
            <i class="fa fa-heart text-white text-sm"></i>
          </div>
          <span class="text-lg font-bold text-primary">æƒ…ç»ªæ—¥è®°</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Toast æç¤º -->
  <div id="toast" class="toast">
    <div class="flex items-center">
      <span class="mr-2">âœ“</span>
      <span id="toastMessage"></span>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 py-8">
    
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-primary mb-2">è®°å½•ä½ çš„æƒ…ç»ª</h1>
      <p class="text-gray-600">è§‰å¯Ÿæƒ…ç»ªæ˜¯ç®¡ç†æƒ…ç»ªçš„ç¬¬ä¸€æ­¥</p>
    </div>

    <!-- è¡¨å•åŒºåŸŸ -->
    <div class="bg-white rounded-2xl p-6 md:p-8 shadow-sm mb-8">
      
      <div class="space-y-8">
        
        <!-- é€‰æ‹©æƒ…ç»ª -->
        <div>
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-smile-o text-primary mr-2"></i>
            ç°åœ¨çš„æƒ…ç»ªæ˜¯ï¼Ÿ
          </label>
          
          <div class="mb-6">
            <div class="text-sm font-medium text-gray-700 mb-3">ç§¯ææƒ…ç»ª</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="emotion-card bg-yellow-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'happy', 'å¼€å¿ƒ', 'ğŸ˜Š', '#FFD93D')">
                <div class="text-4xl mb-2">ğŸ˜Š</div>
                <div class="text-sm font-medium">å¼€å¿ƒ</div>
              </div>
              <div class="emotion-card bg-green-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'calm', 'å¹³é™', 'ğŸ˜Œ', '#A8E6CF')">
                <div class="text-4xl mb-2">ğŸ˜Œ</div>
                <div class="text-sm font-medium">å¹³é™</div>
              </div>
              <div class="emotion-card bg-pink-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'proud', 'è‡ªè±ª', 'ğŸŒŸ', '#FF8B94')">
                <div class="text-4xl mb-2">ğŸŒŸ</div>
                <div class="text-sm font-medium">è‡ªè±ª</div>
              </div>
              <div class="emotion-card bg-purple-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'excited', 'å…´å¥‹', 'ğŸ‰', '#C7CEEA')">
                <div class="text-4xl mb-2">ğŸ‰</div>
                <div class="text-sm font-medium">å…´å¥‹</div>
              </div>
            </div>
          </div>

          <div>
            <div class="text-sm font-medium text-gray-700 mb-3">æ¶ˆææƒ…ç»ª</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="emotion-card bg-red-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'anxious', 'ç„¦è™‘', 'ğŸ˜°', '#FFB6B9')">
                <div class="text-4xl mb-2">ğŸ˜°</div>
                <div class="text-sm font-medium">ç„¦è™‘</div>
              </div>
              <div class="emotion-card bg-blue-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'sad', 'éš¾è¿‡', 'ğŸ˜¢', '#B4A7D6')">
                <div class="text-4xl mb-2">ğŸ˜¢</div>
                <div class="text-sm font-medium">éš¾è¿‡</div>
              </div>
              <div class="emotion-card bg-orange-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'angry', 'æ„¤æ€’', 'ğŸ˜ ', '#FF6B6B')">
                <div class="text-4xl mb-2">ğŸ˜ </div>
                <div class="text-sm font-medium">æ„¤æ€’</div>
              </div>
              <div class="emotion-card bg-gray-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'ashamed', 'ç¾æ„§', 'ğŸ˜³', '#C7CEEA')">
                <div class="text-4xl mb-2">ğŸ˜³</div>
                <div class="text-sm font-medium">ç¾æ„§</div>
              </div>
              <div class="emotion-card bg-indigo-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'fearful', 'ææƒ§', 'ğŸ˜¨', '#A8C5DD')">
                <div class="text-4xl mb-2">ğŸ˜¨</div>
                <div class="text-sm font-medium">ææƒ§</div>
              </div>
              <div class="emotion-card bg-teal-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'disappointed', 'å¤±æœ›', 'ğŸ˜”', '#B5D8EB')">
                <div class="text-4xl mb-2">ğŸ˜”</div>
                <div class="text-sm font-medium">å¤±æœ›</div>
              </div>
              <div class="emotion-card bg-lime-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'jealous', 'å«‰å¦’', 'ğŸ˜’', '#D4E09B')">
                <div class="text-4xl mb-2">ğŸ˜’</div>
                <div class="text-sm font-medium">å«‰å¦’</div>
              </div>
              <div class="emotion-card bg-amber-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'confused', 'å›°æƒ‘', 'ğŸ˜•', '#F5C563')">
                <div class="text-4xl mb-2">ğŸ˜•</div>
                <div class="text-sm font-medium">å›°æƒ‘</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æƒ…ç»ªå¼ºåº¦ -->
        <div id="intensitySection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-signal text-primary mr-2"></i>
            æƒ…ç»ªå¼ºåº¦æœ‰å¤šå¼ºï¼Ÿ
          </label>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600 whitespace-nowrap">è½»å¾®</span>
            <input 
              type="range" 
              id="intensity" 
              min="1" 
              max="10" 
              value="5" 
              class="slider flex-1"
            />
            <span class="text-sm text-gray-600 whitespace-nowrap">å¼ºçƒˆ</span>
          </div>
          <div class="text-center mt-4">
            <div class="text-5xl font-bold text-primary" id="intensityValue">5</div>
            <div class="text-sm text-gray-600">/ 10</div>
          </div>
        </div>

        <!-- è§¦å‘äº‹ä»¶ -->
        <div id="triggerSection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-map-marker text-primary mr-2"></i>
            æ˜¯ä»€ä¹ˆå¼•å‘äº†è¿™ç§æƒ…ç»ªï¼Ÿï¼ˆå¯é€‰ï¼‰
          </label>
          <textarea 
            id="trigger" 
            rows="3" 
            class="w-full p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="æè¿°å‘ç”Ÿçš„äº‹æƒ…ã€æƒ³æ³•æˆ–æƒ…å¢ƒ..."
          ></textarea>
        </div>

        <!-- ç¬”è®° -->
        <div id="notesSection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-pencil text-primary mr-2"></i>
            æƒ³è®°å½•ç‚¹ä»€ä¹ˆå—ï¼Ÿï¼ˆå¯é€‰ï¼‰
          </label>
          <textarea 
            id="notes" 
            rows="4" 
            class="w-full p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="ä½ å¯ä»¥å†™ä¸‹ä»»ä½•æƒ³æ³•ã€æ„Ÿå—æˆ–åæ€..."
          ></textarea>
        </div>

      </div>

      <!-- æŒ‰é’® -->
      <div class="flex gap-4 mt-8">
        <button onclick="window.location.href='cbt_tools.html'" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:border-primary hover:text-primary transition-colors">
          å–æ¶ˆ
        </button>
        <button id="saveButton" onclick="saveEmotion()" class="flex-1 bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed" disabled>
          ä¿å­˜è®°å½•
        </button>
      </div>
    </div>

    <!-- æƒ…ç»ªè¶‹åŠ¿ -->
    <div class="bg-white rounded-2xl p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-primary mb-4">æœ€è¿‘7å¤©æƒ…ç»ªè¶‹åŠ¿</h3>
      <div id="emotionTrend" class="flex items-end justify-between h-40 gap-2">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div class="flex justify-between mt-2 text-xs text-gray-500">
        <span>7å¤©å‰</span>
        <span>ä»Šå¤©</span>
      </div>
    </div>

  </main>

  <script>
 // ========================================
// æƒ…ç»ªæ—¥è®°å®Œæ•´è„šæœ¬ï¼ˆä¿®å¤ç‰ˆï¼‰
// ========================================

// å…¨å±€å˜é‡
let selectedEmotion = null;
const urlParams = new URLSearchParams(window.location.search);
const viewRecordId = urlParams.get('view');
let isViewMode = false;
let currentViewRecord = null;

// Toast æç¤º
function showToast(message) {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// é€‰æ‹©æƒ…ç»ª
function selectEmotion(element, id, label, emoji, color) {
  // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
  document.querySelectorAll('.emotion-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // é€‰ä¸­å½“å‰å¡ç‰‡
  element.classList.add('selected');
  
  selectedEmotion = {
    id: id,
    label: label,
    emoji: emoji,
    color: color
  };
  
  // æ˜¾ç¤ºåç»­éƒ¨åˆ†
  document.getElementById('intensitySection').classList.remove('hidden');
  document.getElementById('triggerSection').classList.remove('hidden');
  document.getElementById('notesSection').classList.remove('hidden');
  
  // å¯ç”¨ä¿å­˜æŒ‰é’®
  const saveButton = document.getElementById('saveButton');
  if (saveButton) {
    saveButton.disabled = false;
    saveButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
    saveButton.classList.add('bg-primary', 'text-white', 'hover:bg-mint', 'cursor-pointer');
  }
  
  // æ»šåŠ¨åˆ°å¼ºåº¦éƒ¨åˆ†
  setTimeout(() => {
    document.getElementById('intensitySection').scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center' 
    });
  }, 100);
}

// å¼ºåº¦æ»‘å—
document.getElementById('intensity')?.addEventListener('input', (e) => {
  document.getElementById('intensityValue').textContent = e.target.value;
});

// ä¿å­˜æƒ…ç»ªè®°å½•
function saveEmotion() {
  if (!selectedEmotion) {
    showToast('è¯·é€‰æ‹©ä¸€ç§æƒ…ç»ª');
    return;
  }

  const record = {
    id: Date.now(),
    date: new Date().toISOString(),
    emotionId: selectedEmotion.id,
    emotionLabel: selectedEmotion.label,
    emoji: selectedEmotion.emoji,
    color: selectedEmotion.color,
    intensity: parseInt(document.getElementById('intensity').value),
    trigger: document.getElementById('trigger').value.trim(),
    notes: document.getElementById('notes').value.trim()
  };

  try {
    const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
    records.push(record);
    localStorage.setItem('emotionDiary', JSON.stringify(records));
    
    showToast('æƒ…ç»ªè®°å½•å·²ä¿å­˜ï¼');
    
    setTimeout(() => {
      window.location.href = 'cbt_tools.html';
    }, 2000);
  } catch (error) {
    console.error('ä¿å­˜å¤±è´¥:', error);
    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// ç”Ÿæˆ7å¤©è¶‹åŠ¿å›¾
function generateEmotionTrend() {
  const container = document.getElementById('emotionTrend');
  if (!container) return;
  
  const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
  
  // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
  const today = new Date();
  const last7Days = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    
    // æ‰¾åˆ°è¿™ä¸€å¤©çš„è®°å½•
    const dayRecords = records.filter(r => {
      const recordDate = new Date(r.date).toISOString().split('T')[0];
      return recordDate === dateStr;
    });
    
    // è®¡ç®—å¹³å‡å¼ºåº¦
    let avgIntensity = 0;
    let emoji = 'ğŸ“Š';
    if (dayRecords.length > 0) {
      const sum = dayRecords.reduce((acc, r) => acc + r.intensity, 0);
      avgIntensity = sum / dayRecords.length;
      emoji = dayRecords[dayRecords.length - 1].emoji;
    }
    
    last7Days.push({
      date: dateStr,
      intensity: avgIntensity,
      emoji: emoji,
      count: dayRecords.length
    });
  }
  
  // æ¸²æŸ“æŸ±çŠ¶å›¾
  container.innerHTML = last7Days.map(day => {
    const height = day.intensity > 0 ? (day.intensity / 10) * 100 : 5;
    const bgColor = day.intensity >= 7 ? 'bg-red-400' : 
                    day.intensity >= 4 ? 'bg-yellow-400' : 
                    day.intensity > 0 ? 'bg-green-400' : 'bg-gray-200';
    
    return `
      <div class="flex-1 flex flex-col items-center justify-end">
        <div class="text-xs mb-1">${day.emoji}</div>
        <div class="${bgColor} w-full rounded-t transition-all hover:opacity-80" 
             style="height: ${height}%"
             title="${day.count > 0 ? `${day.count}æ¡è®°å½•ï¼Œå¹³å‡å¼ºåº¦${day.intensity.toFixed(1)}` : 'æ— è®°å½•'}">
        </div>
      </div>
    `;
  }).join('');
}

// ========================================
// æŸ¥çœ‹æ¨¡å¼åŠŸèƒ½
// ========================================

// åŠ è½½æŸ¥çœ‹æ¨¡å¼
function loadViewMode(recordId) {
  isViewMode = true;
  
  const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
  currentViewRecord = records.find(r => r.id === parseInt(recordId));
  
  if (!currentViewRecord) {
    showToast('æœªæ‰¾åˆ°è¯¥è®°å½•');
    setTimeout(() => {
      window.location.href = 'cbt_tools.html';
    }, 2000);
    return;
  }
  
  switchToViewMode();
  populateViewData();
  showToast('æ­£åœ¨æŸ¥çœ‹å†å²è®°å½•');
}

// åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼UI
function switchToViewMode() {
  // ä¿®æ”¹é¡µé¢æ ‡é¢˜
  const titleEl = document.querySelector('h1.text-3xl');
  if (titleEl) {
    titleEl.textContent = 'æƒ…ç»ªæ—¥è®°è¯¦æƒ…';
  }
  
  // éšè—è¶‹åŠ¿å›¾
  const trendSection = document.querySelector('.bg-white.rounded-2xl.p-6.shadow-sm');
  if (trendSection && trendSection.querySelector('#emotionTrend')) {
    trendSection.style.display = 'none';
  }
  
  // ç¦ç”¨æ‰€æœ‰è¾“å…¥
  document.querySelectorAll('input, textarea').forEach(el => {
    el.disabled = true;
    el.style.opacity = '0.7';
    el.style.cursor = 'not-allowed';
  });
  
  // éšè—ä¿å­˜æŒ‰é’®
  const saveBtn = document.getElementById('saveButton');
  if (saveBtn) saveBtn.style.display = 'none';
  
  // æ˜¾ç¤ºæ‰€æœ‰section
  document.querySelectorAll('#intensitySection, #triggerSection, #notesSection').forEach(section => {
    section.classList.remove('hidden');
  });
  
  // ç¦ç”¨æƒ…ç»ªå¡ç‰‡ç‚¹å‡»
  document.querySelectorAll('.emotion-card').forEach(card => {
    card.style.pointerEvents = 'none';
  });
  
  // æ·»åŠ æ“ä½œæŒ‰é’®
  addViewModeButtons();
}

// å¡«å……æŸ¥çœ‹æ•°æ®
function populateViewData() {
  const record = currentViewRecord;
  
  // é€‰ä¸­å¯¹åº”çš„æƒ…ç»ª
  const emotionCard = document.querySelector(`.emotion-card[onclick*="${record.emotionId}"]`);
  if (emotionCard) {
    emotionCard.classList.add('selected');
    window.selectedEmotion = {
      id: record.emotionId,
      label: record.emotionLabel,
      emoji: record.emoji,
      color: record.color
    };
  }
  
  // å¡«å……å¼ºåº¦
  const intensityInput = document.getElementById('intensity');
  const intensityValue = document.getElementById('intensityValue');
  if (intensityInput) intensityInput.value = record.intensity || 5;
  if (intensityValue) intensityValue.textContent = record.intensity || 5;
  
  // å¡«å……è§¦å‘äº‹ä»¶å’Œç¬”è®°
  const triggerInput = document.getElementById('trigger');
  const notesInput = document.getElementById('notes');
  if (triggerInput) triggerInput.value = record.trigger || '';
  if (notesInput) notesInput.value = record.notes || '';
}

// æ·»åŠ æŸ¥çœ‹æ¨¡å¼æŒ‰é’®
function addViewModeButtons() {
  const formSection = document.querySelector('.max-w-4xl.mx-auto .bg-white.rounded-2xl');
  if (!formSection) return;
  
  // åˆ›å»ºä¿¡æ¯æ 
  const infoBar = document.createElement('div');
  const recordDate = new Date(currentViewRecord.id);
  infoBar.className = 'bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6';
  infoBar.innerHTML = `
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center text-purple-800">
        <span class="text-3xl mr-3">${currentViewRecord.emoji}</span>
        <div>
          <div class="font-semibold text-base">${currentViewRecord.emotionLabel}</div>
          <div class="text-purple-600 mt-1">
            <i class="fa fa-clock-o mr-1"></i>
            ${recordDate.toLocaleString('zh-CN')}
          </div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-2xl font-bold text-purple-700">${currentViewRecord.intensity}</div>
        <div class="text-xs text-purple-600">å¼ºåº¦</div>
      </div>
    </div>
  `;
  
  formSection.insertBefore(infoBar, formSection.firstChild);
  
  // åˆ›å»ºæŒ‰é’®å®¹å™¨
  const buttonContainer = document.createElement('div');
  buttonContainer.className = 'flex gap-4 mt-8 pt-6 border-t border-gray-200';
  buttonContainer.innerHTML = `
    <button onclick="window.location.href='cbt_tools.html'" 
            class="flex-1 border-2 border-primary text-primary py-3 rounded-lg font-medium hover:bg-primary hover:text-white transition-colors">
      <i class="fa fa-arrow-left mr-2"></i>è¿”å›åˆ—è¡¨
    </button>
    <button onclick="editRecord()" 
            class="flex-1 bg-primary text-white py-3 rounded-lg font-medium hover:bg-mint transition-colors">
      <i class="fa fa-edit mr-2"></i>ç¼–è¾‘è®°å½•
    </button>
    <button onclick="deleteRecord()" 
            class="border-2 border-red-500 text-red-500 px-6 py-3 rounded-lg font-medium hover:bg-red-500 hover:text-white transition-colors">
      <i class="fa fa-trash"></i>
    </button>
  `;
  
  formSection.appendChild(buttonContainer);
}

// ç¼–è¾‘è®°å½•
function editRecord() {
  if (confirm('ç¡®å®šè¦ç¼–è¾‘è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    isViewMode = false;
    
    // å¯ç”¨æ‰€æœ‰è¾“å…¥
    document.querySelectorAll('input, textarea').forEach(el => {
      el.disabled = false;
      el.style.opacity = '1';
      el.style.cursor = 'auto';
    });
    
    // å¯ç”¨æƒ…ç»ªå¡ç‰‡
    document.querySelectorAll('.emotion-card').forEach(card => {
      card.style.pointerEvents = 'auto';
    });
    
    // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
    const saveBtn = document.getElementById('saveButton');
    if (saveBtn) {
      saveBtn.style.display = 'block';
      saveBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
      saveBtn.setAttribute('onclick', 'updateRecord()');
      saveBtn.disabled = false;
      saveBtn.classList.remove('bg-gray-300', 'text-gray-500');
      saveBtn.classList.add('bg-primary', 'text-white');
    }
    
    showToast('å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼');
  }
}

// æ›´æ–°è®°å½•
function updateRecord() {
  if (!selectedEmotion) {
    showToast('è¯·é€‰æ‹©ä¸€ç§æƒ…ç»ª');
    return;
  }

  const updatedRecord = {
    id: currentViewRecord.id,
    date: currentViewRecord.date,
    emotionId: selectedEmotion.id,
    emotionLabel: selectedEmotion.label,
    emoji: selectedEmotion.emoji,
    color: selectedEmotion.color,
    intensity: parseInt(document.getElementById('intensity').value),
    trigger: document.getElementById('trigger').value.trim(),
    notes: document.getElementById('notes').value.trim(),
    updatedAt: new Date().toISOString()
  };

  try {
    const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
    const index = records.findIndex(r => r.id === currentViewRecord.id);
    
    if (index !== -1) {
      records[index] = updatedRecord;
      localStorage.setItem('emotionDiary', JSON.stringify(records));
      showToast('è®°å½•å·²æ›´æ–°ï¼');
      
      setTimeout(() => {
        window.location.href = 'cbt_tools.html';
      }, 1500);
    }
  } catch (error) {
    console.error('æ›´æ–°å¤±è´¥:', error);
    showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// åˆ é™¤è®°å½•
function deleteRecord() {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æƒ…ç»ªè®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
    try {
      const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
      const filteredRecords = records.filter(r => r.id !== currentViewRecord.id);
      localStorage.setItem('emotionDiary', JSON.stringify(filteredRecords));
      
      showToast('è®°å½•å·²åˆ é™¤');
      
      setTimeout(() => {
        window.location.href = 'cbt_tools.html';
      }, 1500);
    } catch (error) {
      console.error('åˆ é™¤å¤±è´¥:', error);
      showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
}

// ========================================
// é¡µé¢åˆå§‹åŒ– - ç»Ÿä¸€çš„å…¥å£
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  if (viewRecordId) {
    // æŸ¥çœ‹æ¨¡å¼
    loadViewMode(viewRecordId);
  } else {
    // æ­£å¸¸æ¨¡å¼
    generateEmotionTrend();
    showToast('é€‰æ‹©ä¸€ä¸ªæœ€ç¬¦åˆç°åœ¨æ„Ÿå—çš„æƒ…ç»ª');
  }
});
  </script>

</body>
</html>
