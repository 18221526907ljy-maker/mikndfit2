<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>情绪日记 - MindFit</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#4A6157",
            secondary: "#F7F6F2", 
            accent: "#2E2E2E",
            mint: "#8FD9A8",
          },
        },
      },
    };
  </script>
  
  <style>
    .emotion-card {
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      cursor: pointer;
      border: 3px solid transparent;
    }
    
    .emotion-card:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }

    .emotion-card.selected {
      border-color: #4A6157;
      background: linear-gradient(135deg, rgba(74, 97, 87, 0.05), rgba(143, 217, 168, 0.05));
      transform: scale(1.05);
    }

    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #4A6157;
      cursor: pointer;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #4A6157, #8FD9A8);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.4s ease;
      box-shadow: 0 8px 32px rgba(74, 97, 87, 0.3);
    }

    .toast.show {
      transform: translateX(0);
    }
  </style>
</head>

<body class="bg-secondary font-sans min-h-screen">
  
  <!-- 顶部导航 -->
  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 backdrop-blur-md bg-white/90">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <a href="cbt_tools.html" class="flex items-center text-primary hover:text-mint transition-all duration-300 group">
            <span class="mr-2 transition-transform group-hover:-translate-x-1">←</span>
            <span class="font-medium">返回工具</span>
          </a>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center">
            <i class="fa fa-heart text-white text-sm"></i>
          </div>
          <span class="text-lg font-bold text-primary">情绪日记</span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Toast 提示 -->
  <div id="toast" class="toast">
    <div class="flex items-center">
      <span class="mr-2">✓</span>
      <span id="toastMessage"></span>
    </div>
  </div>

  <main class="max-w-4xl mx-auto px-4 py-8">
    
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-primary mb-2">记录你的情绪</h1>
      <p class="text-gray-600">觉察情绪是管理情绪的第一步</p>
    </div>

    <!-- 表单区域 -->
    <div class="bg-white rounded-2xl p-6 md:p-8 shadow-sm mb-8">
      
      <div class="space-y-8">
        
        <!-- 选择情绪 -->
        <div>
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-smile-o text-primary mr-2"></i>
            现在的情绪是？
          </label>
          
          <div class="mb-6">
            <div class="text-sm font-medium text-gray-700 mb-3">积极情绪</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="emotion-card bg-yellow-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'happy', '开心', '😊', '#FFD93D')">
                <div class="text-4xl mb-2">😊</div>
                <div class="text-sm font-medium">开心</div>
              </div>
              <div class="emotion-card bg-green-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'calm', '平静', '😌', '#A8E6CF')">
                <div class="text-4xl mb-2">😌</div>
                <div class="text-sm font-medium">平静</div>
              </div>
              <div class="emotion-card bg-pink-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'proud', '自豪', '🌟', '#FF8B94')">
                <div class="text-4xl mb-2">🌟</div>
                <div class="text-sm font-medium">自豪</div>
              </div>
              <div class="emotion-card bg-purple-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'excited', '兴奋', '🎉', '#C7CEEA')">
                <div class="text-4xl mb-2">🎉</div>
                <div class="text-sm font-medium">兴奋</div>
              </div>
            </div>
          </div>

          <div>
            <div class="text-sm font-medium text-gray-700 mb-3">消极情绪</div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="emotion-card bg-red-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'anxious', '焦虑', '😰', '#FFB6B9')">
                <div class="text-4xl mb-2">😰</div>
                <div class="text-sm font-medium">焦虑</div>
              </div>
              <div class="emotion-card bg-blue-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'sad', '难过', '😢', '#B4A7D6')">
                <div class="text-4xl mb-2">😢</div>
                <div class="text-sm font-medium">难过</div>
              </div>
              <div class="emotion-card bg-orange-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'angry', '愤怒', '😠', '#FF6B6B')">
                <div class="text-4xl mb-2">😠</div>
                <div class="text-sm font-medium">愤怒</div>
              </div>
              <div class="emotion-card bg-gray-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'ashamed', '羞愧', '😳', '#C7CEEA')">
                <div class="text-4xl mb-2">😳</div>
                <div class="text-sm font-medium">羞愧</div>
              </div>
              <div class="emotion-card bg-indigo-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'fearful', '恐惧', '😨', '#A8C5DD')">
                <div class="text-4xl mb-2">😨</div>
                <div class="text-sm font-medium">恐惧</div>
              </div>
              <div class="emotion-card bg-teal-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'disappointed', '失望', '😔', '#B5D8EB')">
                <div class="text-4xl mb-2">😔</div>
                <div class="text-sm font-medium">失望</div>
              </div>
              <div class="emotion-card bg-lime-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'jealous', '嫉妒', '😒', '#D4E09B')">
                <div class="text-4xl mb-2">😒</div>
                <div class="text-sm font-medium">嫉妒</div>
              </div>
              <div class="emotion-card bg-amber-50 rounded-xl p-4 text-center" onclick="selectEmotion(this, 'confused', '困惑', '😕', '#F5C563')">
                <div class="text-4xl mb-2">😕</div>
                <div class="text-sm font-medium">困惑</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 情绪强度 -->
        <div id="intensitySection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-signal text-primary mr-2"></i>
            情绪强度有多强？
          </label>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-600 whitespace-nowrap">轻微</span>
            <input 
              type="range" 
              id="intensity" 
              min="1" 
              max="10" 
              value="5" 
              class="slider flex-1"
            />
            <span class="text-sm text-gray-600 whitespace-nowrap">强烈</span>
          </div>
          <div class="text-center mt-4">
            <div class="text-5xl font-bold text-primary" id="intensityValue">5</div>
            <div class="text-sm text-gray-600">/ 10</div>
          </div>
        </div>

        <!-- 触发事件 -->
        <div id="triggerSection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-map-marker text-primary mr-2"></i>
            是什么引发了这种情绪？（可选）
          </label>
          <textarea 
            id="trigger" 
            rows="3" 
            class="w-full p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="描述发生的事情、想法或情境..."
          ></textarea>
        </div>

        <!-- 笔记 -->
        <div id="notesSection" class="hidden">
          <label class="block text-lg font-semibold text-gray-800 mb-4">
            <i class="fa fa-pencil text-primary mr-2"></i>
            想记录点什么吗？（可选）
          </label>
          <textarea 
            id="notes" 
            rows="4" 
            class="w-full p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="你可以写下任何想法、感受或反思..."
          ></textarea>
        </div>

      </div>

      <!-- 按钮 -->
      <div class="flex gap-4 mt-8">
        <button onclick="window.location.href='cbt_tools.html'" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:border-primary hover:text-primary transition-colors">
          取消
        </button>
        <button id="saveButton" onclick="saveEmotion()" class="flex-1 bg-gray-300 text-gray-500 py-3 rounded-lg font-medium cursor-not-allowed" disabled>
          保存记录
        </button>
      </div>
    </div>

    <!-- 情绪趋势 -->
    <div class="bg-white rounded-2xl p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-primary mb-4">最近7天情绪趋势</h3>
      <div id="emotionTrend" class="flex items-end justify-between h-40 gap-2">
        <!-- 动态生成 -->
      </div>
      <div class="flex justify-between mt-2 text-xs text-gray-500">
        <span>7天前</span>
        <span>今天</span>
      </div>
    </div>

  </main>

  <script>
 // ========================================
// 情绪日记完整脚本（修复版）
// ========================================

// 全局变量
let selectedEmotion = null;
const urlParams = new URLSearchParams(window.location.search);
const viewRecordId = urlParams.get('view');
let isViewMode = false;
let currentViewRecord = null;

// Toast 提示
function showToast(message) {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// 选择情绪
function selectEmotion(element, id, label, emoji, color) {
  // 移除所有选中状态
  document.querySelectorAll('.emotion-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // 选中当前卡片
  element.classList.add('selected');
  
  selectedEmotion = {
    id: id,
    label: label,
    emoji: emoji,
    color: color
  };
  
  // 显示后续部分
  document.getElementById('intensitySection').classList.remove('hidden');
  document.getElementById('triggerSection').classList.remove('hidden');
  document.getElementById('notesSection').classList.remove('hidden');
  
  // 启用保存按钮
  const saveButton = document.getElementById('saveButton');
  if (saveButton) {
    saveButton.disabled = false;
    saveButton.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
    saveButton.classList.add('bg-primary', 'text-white', 'hover:bg-mint', 'cursor-pointer');
  }
  
  // 滚动到强度部分
  setTimeout(() => {
    document.getElementById('intensitySection').scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center' 
    });
  }, 100);
}

// 强度滑块
document.getElementById('intensity')?.addEventListener('input', (e) => {
  document.getElementById('intensityValue').textContent = e.target.value;
});

// 保存情绪记录
function saveEmotion() {
  if (!selectedEmotion) {
    showToast('请选择一种情绪');
    return;
  }

  const record = {
    id: Date.now(),
    date: new Date().toISOString(),
    emotionId: selectedEmotion.id,
    emotionLabel: selectedEmotion.label,
    emoji: selectedEmotion.emoji,
    color: selectedEmotion.color,
    intensity: parseInt(document.getElementById('intensity').value),
    trigger: document.getElementById('trigger').value.trim(),
    notes: document.getElementById('notes').value.trim()
  };

  try {
    const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
    records.push(record);
    localStorage.setItem('emotionDiary', JSON.stringify(records));
    
    showToast('情绪记录已保存！');
    
    setTimeout(() => {
      window.location.href = 'cbt_tools.html';
    }, 2000);
  } catch (error) {
    console.error('保存失败:', error);
    showToast('保存失败，请重试');
  }
}

// 生成7天趋势图
function generateEmotionTrend() {
  const container = document.getElementById('emotionTrend');
  if (!container) return;
  
  const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
  
  // 获取最近7天的数据
  const today = new Date();
  const last7Days = [];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    
    // 找到这一天的记录
    const dayRecords = records.filter(r => {
      const recordDate = new Date(r.date).toISOString().split('T')[0];
      return recordDate === dateStr;
    });
    
    // 计算平均强度
    let avgIntensity = 0;
    let emoji = '📊';
    if (dayRecords.length > 0) {
      const sum = dayRecords.reduce((acc, r) => acc + r.intensity, 0);
      avgIntensity = sum / dayRecords.length;
      emoji = dayRecords[dayRecords.length - 1].emoji;
    }
    
    last7Days.push({
      date: dateStr,
      intensity: avgIntensity,
      emoji: emoji,
      count: dayRecords.length
    });
  }
  
  // 渲染柱状图
  container.innerHTML = last7Days.map(day => {
    const height = day.intensity > 0 ? (day.intensity / 10) * 100 : 5;
    const bgColor = day.intensity >= 7 ? 'bg-red-400' : 
                    day.intensity >= 4 ? 'bg-yellow-400' : 
                    day.intensity > 0 ? 'bg-green-400' : 'bg-gray-200';
    
    return `
      <div class="flex-1 flex flex-col items-center justify-end">
        <div class="text-xs mb-1">${day.emoji}</div>
        <div class="${bgColor} w-full rounded-t transition-all hover:opacity-80" 
             style="height: ${height}%"
             title="${day.count > 0 ? `${day.count}条记录，平均强度${day.intensity.toFixed(1)}` : '无记录'}">
        </div>
      </div>
    `;
  }).join('');
}

// ========================================
// 查看模式功能
// ========================================

// 加载查看模式
function loadViewMode(recordId) {
  isViewMode = true;
  
  const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
  currentViewRecord = records.find(r => r.id === parseInt(recordId));
  
  if (!currentViewRecord) {
    showToast('未找到该记录');
    setTimeout(() => {
      window.location.href = 'cbt_tools.html';
    }, 2000);
    return;
  }
  
  switchToViewMode();
  populateViewData();
  showToast('正在查看历史记录');
}

// 切换到查看模式UI
function switchToViewMode() {
  // 修改页面标题
  const titleEl = document.querySelector('h1.text-3xl');
  if (titleEl) {
    titleEl.textContent = '情绪日记详情';
  }
  
  // 隐藏趋势图
  const trendSection = document.querySelector('.bg-white.rounded-2xl.p-6.shadow-sm');
  if (trendSection && trendSection.querySelector('#emotionTrend')) {
    trendSection.style.display = 'none';
  }
  
  // 禁用所有输入
  document.querySelectorAll('input, textarea').forEach(el => {
    el.disabled = true;
    el.style.opacity = '0.7';
    el.style.cursor = 'not-allowed';
  });
  
  // 隐藏保存按钮
  const saveBtn = document.getElementById('saveButton');
  if (saveBtn) saveBtn.style.display = 'none';
  
  // 显示所有section
  document.querySelectorAll('#intensitySection, #triggerSection, #notesSection').forEach(section => {
    section.classList.remove('hidden');
  });
  
  // 禁用情绪卡片点击
  document.querySelectorAll('.emotion-card').forEach(card => {
    card.style.pointerEvents = 'none';
  });
  
  // 添加操作按钮
  addViewModeButtons();
}

// 填充查看数据
function populateViewData() {
  const record = currentViewRecord;
  
  // 选中对应的情绪
  const emotionCard = document.querySelector(`.emotion-card[onclick*="${record.emotionId}"]`);
  if (emotionCard) {
    emotionCard.classList.add('selected');
    window.selectedEmotion = {
      id: record.emotionId,
      label: record.emotionLabel,
      emoji: record.emoji,
      color: record.color
    };
  }
  
  // 填充强度
  const intensityInput = document.getElementById('intensity');
  const intensityValue = document.getElementById('intensityValue');
  if (intensityInput) intensityInput.value = record.intensity || 5;
  if (intensityValue) intensityValue.textContent = record.intensity || 5;
  
  // 填充触发事件和笔记
  const triggerInput = document.getElementById('trigger');
  const notesInput = document.getElementById('notes');
  if (triggerInput) triggerInput.value = record.trigger || '';
  if (notesInput) notesInput.value = record.notes || '';
}

// 添加查看模式按钮
function addViewModeButtons() {
  const formSection = document.querySelector('.max-w-4xl.mx-auto .bg-white.rounded-2xl');
  if (!formSection) return;
  
  // 创建信息栏
  const infoBar = document.createElement('div');
  const recordDate = new Date(currentViewRecord.id);
  infoBar.className = 'bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6';
  infoBar.innerHTML = `
    <div class="flex items-center justify-between text-sm">
      <div class="flex items-center text-purple-800">
        <span class="text-3xl mr-3">${currentViewRecord.emoji}</span>
        <div>
          <div class="font-semibold text-base">${currentViewRecord.emotionLabel}</div>
          <div class="text-purple-600 mt-1">
            <i class="fa fa-clock-o mr-1"></i>
            ${recordDate.toLocaleString('zh-CN')}
          </div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-2xl font-bold text-purple-700">${currentViewRecord.intensity}</div>
        <div class="text-xs text-purple-600">强度</div>
      </div>
    </div>
  `;
  
  formSection.insertBefore(infoBar, formSection.firstChild);
  
  // 创建按钮容器
  const buttonContainer = document.createElement('div');
  buttonContainer.className = 'flex gap-4 mt-8 pt-6 border-t border-gray-200';
  buttonContainer.innerHTML = `
    <button onclick="window.location.href='cbt_tools.html'" 
            class="flex-1 border-2 border-primary text-primary py-3 rounded-lg font-medium hover:bg-primary hover:text-white transition-colors">
      <i class="fa fa-arrow-left mr-2"></i>返回列表
    </button>
    <button onclick="editRecord()" 
            class="flex-1 bg-primary text-white py-3 rounded-lg font-medium hover:bg-mint transition-colors">
      <i class="fa fa-edit mr-2"></i>编辑记录
    </button>
    <button onclick="deleteRecord()" 
            class="border-2 border-red-500 text-red-500 px-6 py-3 rounded-lg font-medium hover:bg-red-500 hover:text-white transition-colors">
      <i class="fa fa-trash"></i>
    </button>
  `;
  
  formSection.appendChild(buttonContainer);
}

// 编辑记录
function editRecord() {
  if (confirm('确定要编辑这条记录吗？')) {
    isViewMode = false;
    
    // 启用所有输入
    document.querySelectorAll('input, textarea').forEach(el => {
      el.disabled = false;
      el.style.opacity = '1';
      el.style.cursor = 'auto';
    });
    
    // 启用情绪卡片
    document.querySelectorAll('.emotion-card').forEach(card => {
      card.style.pointerEvents = 'auto';
    });
    
    // 显示保存按钮
    const saveBtn = document.getElementById('saveButton');
    if (saveBtn) {
      saveBtn.style.display = 'block';
      saveBtn.textContent = '保存修改';
      saveBtn.setAttribute('onclick', 'updateRecord()');
      saveBtn.disabled = false;
      saveBtn.classList.remove('bg-gray-300', 'text-gray-500');
      saveBtn.classList.add('bg-primary', 'text-white');
    }
    
    showToast('已进入编辑模式');
  }
}

// 更新记录
function updateRecord() {
  if (!selectedEmotion) {
    showToast('请选择一种情绪');
    return;
  }

  const updatedRecord = {
    id: currentViewRecord.id,
    date: currentViewRecord.date,
    emotionId: selectedEmotion.id,
    emotionLabel: selectedEmotion.label,
    emoji: selectedEmotion.emoji,
    color: selectedEmotion.color,
    intensity: parseInt(document.getElementById('intensity').value),
    trigger: document.getElementById('trigger').value.trim(),
    notes: document.getElementById('notes').value.trim(),
    updatedAt: new Date().toISOString()
  };

  try {
    const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
    const index = records.findIndex(r => r.id === currentViewRecord.id);
    
    if (index !== -1) {
      records[index] = updatedRecord;
      localStorage.setItem('emotionDiary', JSON.stringify(records));
      showToast('记录已更新！');
      
      setTimeout(() => {
        window.location.href = 'cbt_tools.html';
      }, 1500);
    }
  } catch (error) {
    console.error('更新失败:', error);
    showToast('更新失败，请重试');
  }
}

// 删除记录
function deleteRecord() {
  if (confirm('确定要删除这条情绪记录吗？此操作无法撤销。')) {
    try {
      const records = JSON.parse(localStorage.getItem('emotionDiary') || '[]');
      const filteredRecords = records.filter(r => r.id !== currentViewRecord.id);
      localStorage.setItem('emotionDiary', JSON.stringify(filteredRecords));
      
      showToast('记录已删除');
      
      setTimeout(() => {
        window.location.href = 'cbt_tools.html';
      }, 1500);
    } catch (error) {
      console.error('删除失败:', error);
      showToast('删除失败，请重试');
    }
  }
}

// ========================================
// 页面初始化 - 统一的入口
// ========================================
document.addEventListener('DOMContentLoaded', () => {
  if (viewRecordId) {
    // 查看模式
    loadViewMode(viewRecordId);
  } else {
    // 正常模式
    generateEmotionTrend();
    showToast('选择一个最符合现在感受的情绪');
  }
});
  </script>

</body>
</html>
